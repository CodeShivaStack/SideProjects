<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* --- Global --- */
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
body { background: #f5f7fa; color: #2c3e50; }

/* --- Header --- */
header {
  background: #1f2937; color: white; padding: 1rem 2rem;
  display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
header h1 { font-weight: 600; font-size: 1.25rem; }
header button { background: #3b82f6; padding: 0.5rem 1rem; border-radius: 6px; transition: 0.2s; display: flex; align-items: center; gap: 0.5rem; }
header button:hover { background: #2563eb; }

/* --- Sidebar --- */
nav {
  width: 220px; background: #111827; height: 100vh; position: fixed; top: 0; left: 0;
  display: flex; flex-direction: column; padding-top: 4rem; transition: 0.3s;
  overflow-y: auto;
}
nav a {
  color: #e5e7eb; padding: 1rem 1.5rem; text-decoration: none; font-weight: 500;
  transition: 0.2s; border-left: 4px solid transparent; display: flex; align-items: center; gap: 0.5rem;
}
nav a:hover { background: #1f2937; border-left: 4px solid #3b82f6; }
nav a.active { background: #1f2937; border-left: 4px solid #3b82f6; }

/* --- Main Content --- */
main {
  margin-left: 220px; padding: 2rem; transition: 0.3s;
}
section { display: none; }
section.active { display: block; }

/* --- Cards --- */
.card {
  background: white; padding: 1.25rem 1.5rem; border-radius: 12px; display: inline-block;
  margin-right: 1rem; margin-bottom: 1rem; min-width: 180px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  transition: 0.2s;
}
.card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.card i { margin-right: 0.5rem; color: #3b82f6; }

/* --- Tables --- */
table { width: 100%; border-collapse: collapse; margin-top: 1rem; border-radius: 8px; overflow: hidden; }
th, td { padding: 0.75rem 1rem; text-align: left; }
th { background: #3b82f6; color: white; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; }
tbody tr { background: white; border-bottom: 1px solid #e5e7eb; transition: 0.2s; }
tbody tr:hover { background: #f3f4f6; }
td button { background: #10b981; color: white; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.85rem; transition: 0.2s; }
td button:hover { background: #059669; }

/* --- Export Buttons --- */
.export-btn { background: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 6px; margin-top: 0.75rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: 0.2s; }
.export-btn:hover { background: #2563eb; }

/* --- Responsive --- */

/* Tablet */
@media (max-width: 1024px) {
  nav { width: 180px; padding-top: 3rem; }
  main { margin-left: 180px; padding: 1.5rem; }
  .card { min-width: 150px; margin-right: 0.5rem; margin-bottom: 1rem; }
  th, td { padding: 0.5rem 0.75rem; font-size: 0.85rem; }
}

/* Mobile */
@media (max-width: 768px) {
  nav {
    position: relative; width: 100%; height: auto; flex-direction: row; padding-top: 0; overflow-x: auto;
  }
  nav a { flex: 1; text-align: center; border-left: none; border-bottom: 2px solid transparent; }
  nav a.active { border-bottom: 2px solid #3b82f6; }
  main { margin-left: 0; padding: 1rem; }
  .card { display: block; width: 100%; margin-right: 0; }
  table { font-size: 0.8rem; }
  header { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
  header button { width: 100%; justify-content: center; }
}

/* Chart responsiveness */
canvas { width: 100% !important; height: auto !important; }
</style>

</head>
<body>

<header>
  <h1>Admin Dashboard</h1>
  <button id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
</header>

<nav>
  <a href="#" class="active" onclick="showSection('bookingsSection', this)"><i class="fa-solid fa-bed"></i> Bookings</a>
  <a href="#" onclick="showSection('contactsSection', this)"><i class="fa-solid fa-envelope"></i> Contacts</a>
  <a href="#" onclick="showSection('analyticsSection', this)"><i class="fa-solid fa-chart-line"></i> Analytics</a>
</nav>

<main>
  <!-- Bookings -->
  <section id="bookingsSection" class="active">
    <h2>Bookings</h2>
    <button class="export-btn" onclick="exportBookingsCSV()"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
    <table>
      <thead>
        <tr><th>Name</th><th>Phone</th><th>Date</th><th>Rooms</th><th>Guests</th><th>Created At</th><th>Notify</th></tr>
      </thead>
      <tbody id="bookingTable"></tbody>
    </table>
  </section>

  <!-- Contacts -->
  <section id="contactsSection">
    <h2>Contacts</h2>
    <button class="export-btn" onclick="exportContactsCSV()"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
    <table>
      <thead>
        <tr><th>Name</th><th>Email</th><th>Phone</th><th>Subject</th><th>Message</th><th>Created At</th><th>Notify</th></tr>
      </thead>
      <tbody id="contactTable"></tbody>
    </table>
  </section>

  <!-- Analytics -->
  <section id="analyticsSection">
    <h2>Analytics</h2>
    <div class="card"><i class="fa-solid fa-calendar-day"></i> Bookings Today: <span id="totalToday">0</span></div>
    <div class="card"><i class="fa-solid fa-calendar-week"></i> Bookings This Week: <span id="totalWeek">0</span></div>
    <div class="card"><i class="fa-solid fa-calendar-alt"></i> Total Bookings: <span id="totalBookings">0</span></div>
    <canvas id="bookingsChart" width="400" height="150" style="margin-top:2rem;"></canvas>
  </section>
</main>

<script>
    const supabaseClient = supabase.createClient("https://bmfbvckahnuwfmdaqjts.supabase.co", "sb_publishable_hroobSDDhZnbywmpkqaXHQ_uFUc_4kR");
  

// Redirect if not logged in
(async()=>{
  const { data:{session} } = await supabaseClient.auth.getSession();
  if(!session) window.location.href='/VimalResort/Next/admin-login.html';
})();

// Section switching
function showSection(sectionId, link){
  document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
  link.classList.add('active');
  document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
  document.getElementById(sectionId).classList.add('active');
}

// Logout
document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  await supabaseClient.auth.signOut();
  window.location.href='/VimalResort/Next/admin-login.html';
});

// Data
let bookingsData=[], contactsData=[];

// Rate-limiting map
const submissionMap = {}; // key=email|phone value=timestamp

// Check if a submission is spam
function isSpam(key){
  const now=Date.now();
  const last=submissionMap[key]||0;
  if(now-last<2*60*1000){ // 2 minutes
    return true;
  }
  submissionMap[key]=now;
  return false;
}

// Render Bookings
function renderBookings(data){
  bookingsData=data;
  const tbody=document.getElementById('bookingTable');
  tbody.innerHTML='';
  const todayStr=new Date().toISOString().split('T')[0];
  let weekCount=0;
  data.forEach(b=>{
    const created=new Date(b.created_at);
    if(created.toISOString().split('T')[0]===todayStr) document.getElementById('totalToday').textContent++;
    const weekAgo=new Date();
    weekAgo.setDate(weekAgo.getDate()-7);
    if(created>weekAgo) weekCount++;
    tbody.innerHTML+=`<tr>
      <td>${b.name}</td>
      <td>${b.phone}</td>
      <td>${b.date}</td>
      <td>${b.rooms}</td>
      <td>${b.guests}</td>
      <td>${new Date(b.created_at).toLocaleString()}</td>
      <td><button onclick="notifyWhatsApp('${b.phone}','${b.name}','${b.date}')"><i class="fa-brands fa-whatsapp"></i></button></td>
    </tr>`;
  });
  document.getElementById('totalWeek').textContent=weekCount;
  document.getElementById('totalBookings').textContent=data.length;
  renderChart(data);
}

// Render Contacts
function renderContacts(data){
  contactsData=data;
  const tbody=document.getElementById('contactTable');
  tbody.innerHTML='';
  data.forEach(c=>{
    tbody.innerHTML+=`<tr>
      <td>${c.name}</td>
      <td>${c.email}</td>
      <td>${c.phone}</td>
      <td>${c.subject}</td>
      <td>${c.message}</td>
      <td>${new Date(c.created_at).toLocaleString()}</td>
      <td><button onclick="notifyWhatsApp('${c.phone}','${c.name}','Message')"><i class="fa-brands fa-whatsapp"></i></button></td>
    </tr>`;
  });
}

// CSV Export
function downloadCSV(data, filename){
  if(!data.length) return;
  const headers=Object.keys(data[0]).join(',');
  const rows=data.map(r=>Object.values(r).join(','));
  const csv=[headers,...rows].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}
function exportBookingsCSV(){ downloadCSV(bookingsData,'bookings.csv'); }
function exportContactsCSV(){ downloadCSV(contactsData,'contacts.csv'); }

// WhatsApp Notification
function notifyWhatsApp(phone,name,date){
  const msg=encodeURIComponent(`Hello ${name}, regarding your booking/message on ${date}`);
  window.open(`https://wa.me/${phone}?text=${msg}`,'_blank');
}

// Render Chart
let chartInstance;
function renderChart(bookings){
  // Count bookings by date
  const counts={};
  bookings.forEach(b=>{
    const d=new Date(b.created_at);
    const day=d.toISOString().split('T')[0];
    counts[day]=(counts[day]||0)+1;
  });
  const labels=Object.keys(counts).sort();
  const data=labels.map(d=>counts[d]);
  const ctx=document.getElementById('bookingsChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance=new Chart(ctx,{
    type:'line',
    data:{
      labels:labels,
      datasets:[{
        label:'Bookings',
        data:data,
        backgroundColor:'rgba(59,130,246,0.2)',
        borderColor:'#3b82f6',
        borderWidth:2,
        fill:true,
        tension:0.4,
        pointRadius:4
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:true,position:'top'},
        tooltip:{mode:'index',intersect:false}
      },
      interaction:{mode:'nearest',axis:'x',intersect:false},
      scales:{
        x:{title:{display:true,text:'Date'}},
        y:{title:{display:true,text:'No. of Bookings'},beginAtZero:true,precision:0}
      }
    }
  });
}

// Load data
async function loadBookings(){
  const {data,error}=await supabaseClient.from('bookings').select('*').order('created_at',{ascending:false});
  if(!error) renderBookings(data);
}
async function loadContacts(){
  const {data,error}=await supabaseClient.from('contacts').select('*').order('created_at',{ascending:false});
  if(!error) renderContacts(data);
}

// Supabase Realtime
supabaseClient.channel('public:bookings')
.on('postgres_changes',{event:'INSERT',schema:'public',table:'bookings'},()=>{loadBookings();})
.subscribe();
supabaseClient.channel('public:contacts')
.on('postgres_changes',{event:'INSERT',schema:'public',table:'contacts'},()=>{loadContacts();})
.subscribe();

// Initial load
loadBookings();
loadContacts();
</script>
</body>
</html>
